<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>World Radio</title>
  <meta name="description" content="Lyssna pÃ¥ radiostationer frÃ¥n hela vÃ¤rlden. SÃ¶k via egen Cloudflare Worker-proxy. Spara favoriter.">
  <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
  <link rel="icon" href="favicon-radio.svg" type="image/svg+xml">
  <link rel="mask-icon" href="favicon-radio.svg" color="#b1ffd2">
  <meta name="theme-color" content="#000000">
  <style>
    :root{
      --bg:#000;--panel:#12131a;--muted:#7a8194;--text:#e6e9f2;--accent:#4f46e5;--border:#222433;
      --green:#b1ffd2; --player-h: 150px; --ticker-h: 34px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    html{ -webkit-text-size-adjust: 100%; }
    body{
      margin:0;font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif;color:var(--text);
      background:#000; touch-action: manipulation;
      padding-bottom: calc(var(--ticker-h) + var(--player-h) + env(safe-area-inset-bottom) + 20px);
    }
    a { text-decoration:none; color:inherit; border-bottom:0; }
    header{position:sticky;top:0;background:rgba(0,0,0,.72);backdrop-filter:blur(8px);z-index:10;border-bottom:1px solid var(--border)}
    .wrap{max-width:1100px;margin:0 auto;padding:14px 12px}
    .title{display:flex;gap:8px;align-items:center;font-weight:700}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(0,0,0,.05));border:1px solid var(--border);border-radius:14px;padding:10px;display:flex;gap:10px;align-items:flex-start;cursor:pointer}
    .card:hover{border-color:#2a2d40}
    .card .clickIgnore{ cursor: default; } /* knappar ska inte trigga kort-klick */
    .station-cover{flex:0 0 auto;width:50px;height:50px;border-radius:12px;background:#0e0f15;border:1px solid var(--border);display:grid;place-items:center;overflow:hidden}
    .station-cover img{width:100%;height:100%;object-fit:cover}
    .muted{color:var(--muted)}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    input[type="search"], select{
      background:#0e0f15;border:1px solid var(--border);color:var(--text);padding:10px 12px;border-radius:10px;width:100%;
      font-size:16px;
    }
    .pill{font-size:12px;padding:2px 6px;border:1px solid var(--border);border-radius:999px;color:var(--muted)}

    /* === JÃ¤mnstora knappar pÃ¥ korten === */
    .controls{ display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:8px }
    .controls .btn{width:100%;height:44px;display:flex;align-items:center;justify-content:center}
    .controls .iconbtn .ico{width:18px;height:18px}

    /* Digital/retro stil */
    .digital{ font-family:'VT323',ui-monospace,Consolas,monospace; letter-spacing:.03em; color:var(--green); text-shadow:0 0 6px rgba(177,255,210,.45); }
    .btn{
      background:#0c0e13;border:1px solid #2a2d40;padding:9px 12px;border-radius:10px;cursor:pointer;font-size:18px;
      text-decoration:none;
    }
    .btn:hover{border-color:#3b3f56}
    .btn.primary{background:linear-gradient(180deg,#141a26,#0e1420);border-color:#3b3f56}
    .btn.small{padding:6px 9px;border-radius:8px}
    .btn.ghost{background:transparent;border:1px dashed #2a2d40}
    .btn:link,.btn:visited{ text-decoration:none }
    .iconbtn{display:inline-flex;align-items:center;justify-content:center;min-width:44px;line-height:1;text-decoration:none;border-bottom:0}
    .h{margin:16px 0 8px;font-size:13px;color:#aab3d0;text-transform:uppercase;letter-spacing:.12em}
    .empty{opacity:.7;border:1px dashed var(--border);border-radius:10px;padding:14px;text-align:center}
    .diag{margin-top:8px;font-size:12px;color:#fbbf24}
    .toast{position:fixed;right:12px;bottom:calc(var(--ticker-h) + var(--player-h) + env(safe-area-inset-bottom) + 12px);background:#1b1d29;color:#e6e9f2;border:1px solid #2a2d40;padding:7px 9px;border-radius:9px;font-size:13px;opacity:0;transform:translateY(6px);transition:.18s}
    .toast.show{opacity:1;transform:none}

    /* Taggar visas bara nÃ¤r kortet har klassen .show-tags */
    .tags{ display:none; }
    .card.show-tags .tags{ display:flex; }

    /* Ticker (kopieringsbar) */
    .ticker{
      position:fixed;left:0;right:0;bottom:calc(var(--player-h) + env(safe-area-inset-bottom));
      height:var(--ticker-h); background:#0a1112;border-top:1px solid var(--border);border-bottom:1px solid var(--border);
      display:none;align-items:center;overflow:hidden;z-index:20; cursor:pointer;
    }
    .tickerInner{ width:100%;white-space:nowrap;overflow:hidden; }
    .tickerInner .digital{ font-size:22px;line-height:1;display:inline-block;padding-left:100%; animation:ticker 20s linear infinite; }
    @keyframes ticker{ from{ transform:translateX(0);} to{ transform:translateX(-100%);} }

    /* ===================== Spelare (mobil-fÃ¶rst) ===================== */
    .audio{
      position:fixed;left:0;right:0;bottom:0;
      height:calc(var(--player-h) + env(safe-area-inset-bottom));
      background:#000; border-top:1px solid var(--border);
      padding:12px; padding-bottom:calc(12px + env(safe-area-inset-bottom));
      z-index:21;
      display:block;
    }
    .player-grid{ display:flex; align-items:center; gap:12px; max-width:1100px; margin:0 auto; }
    .audio .station-cover{width:72px;height:72px;border-radius:14px; flex:0 0 auto}
    .audio .meta{min-width:0;display:flex;flex-direction:column;gap:6px;flex:1}
    .meta .name{font-size:22px}
    #playerName{ display:block; line-height:1.25; max-height: calc(1.25em * 2); overflow:hidden; white-space:normal; }
    #playerDetails{ font-size:13px; white-space:normal; }
    .liveDot{width:10px;height:10px;border-radius:50%;background:#ef4444;box-shadow:0 0 12px rgba(239,68,68,.8);margin-right:6px;display:inline-block;vertical-align:middle}
    .audio-controls{display:flex;gap:8px;align-items:center;margin-left:auto;flex-wrap:wrap}
    .ico{width:20px;height:20px; display:block; stroke:var(--green); fill:none; stroke-width:1.9;
         filter:drop-shadow(0 0 6px rgba(177,255,210,.45));}
    .ico-fill{ fill:var(--green); stroke:none; filter:drop-shadow(0 0 6px rgba(177,255,210,.45)); }

    /* Volym-popover */
    .vol-wrap{position:relative}
    .vol-pop{
      position:absolute; right:0; bottom:calc(100% + 10px);
      background:#0d0f14;border:1px solid #2a2d40;border-radius:12px;padding:10px; z-index:30;
      box-shadow:0 6px 20px rgba(0,0,0,.35); display:none;
    }
    .vol-pop.show{ display:block; }
    .vol-slider{
      display:block; margin:0 auto; width:32px; height:150px;
      writing-mode: bt-lr; -webkit-appearance: slider-vertical; appearance: slider-vertical;
      background:transparent;
    }
    .vol-slider::-webkit-slider-runnable-track{ background:linear-gradient(180deg,#0c1320,#0a0f18); border:1px solid #2a2d40; width:6px; border-radius:999px; }
    .vol-slider::-webkit-slider-thumb{ -webkit-appearance:none; width:18px; height:18px; border-radius:50%;
      background:var(--green); box-shadow:0 0 10px rgba(177,255,210,.55); margin-top:-6px; }
    .vol-slider::-moz-range-track{ background:#0c1320; border:1px solid #2a2d40; }
    .vol-slider::-moz-range-thumb{ width:18px; height:18px; border-radius:50%; background:var(--green); box-shadow:0 0 10px rgba(177,255,210,.55); }

    /* Mobil: text ovanfÃ¶r knappar (grid areas) + 3 rader namn */
    @media (max-width: 720px){
      :root{ --player-h: 170px; }
      .player-grid{
        display:grid;
        grid-template-columns: 84px 1fr;
        grid-template-areas:
          "cover meta"
          "controls controls";
        gap:10px 12px;
        align-items:start;
      }
      #playerCover{ grid-area: cover; }
      .audio .meta{ grid-area: meta; }
      .audio-controls{ grid-area: controls; margin-left:0; justify-content:space-between; }
      #playerName{ max-height: calc(1.25em * 3); }
    }

    /* Favoriter-vy */
    body.mode-favs #resultsSection{display:none}
    body.mode-favs #favsSection{display:block}

    .copyable{ cursor: pointer; }

    /* Sentinel (oÃ¤ndlig scroll) */
    #sentinel{ height: 1px; }
  </style>
</head>
<body>
  <!-- SVG-sprite -->
  <svg width="0" height="0" style="position:absolute;left:-9999px;top:-9999px">
    <defs>
      <symbol id="ico-play" viewBox="0 0 24 24"><polygon points="8,5 19,12 8,19"></polygon></symbol>
      <symbol id="ico-pause" viewBox="0 0 24 24"><rect x="6" y="5" width="4" height="14"></rect><rect x="14" y="5" width="4" height="14"></rect></symbol>
      <symbol id="ico-stop" viewBox="0 0 24 24"><rect x="6" y="6" width="12" height="12"></rect></symbol>
      <symbol id="ico-volume" viewBox="0 0 24 24">
        <path d="M11 5 L6 9 H3 v6 h3 l5 4 z"></path>
        <path d="M15 9 q3 3 0 6" stroke-linecap="round"></path>
        <path d="M17 7 q6 5 0 10" stroke-linecap="round"></path>
      </symbol>
      <symbol id="ico-volume-mute" viewBox="0 0 24 24">
        <path d="M11 5 L6 9 H3 v6 h3 l5 4 z"></path>
        <path d="M16 8 L20 16"></path><path d="M20 8 L16 16"></path>
      </symbol>
      <symbol id="ico-globe" viewBox="0 0 24 24">
        <circle cx="12" cy="12" r="9"></circle>
        <path d="M3 12 h18"></path>
        <path d="M12 3 a9 9 0 0 1 0 18 a9 9 0 0 1 0 -18 z" fill="none"></path>
        <path d="M12 3 c3 3 3 15 0 18 c-3 -3 -3 -15 0 -18 z"></path>
      </symbol>
      <!-- Spotify-ikon -->
      <symbol id="ico-spotify" viewBox="0 0 24 24">
        <circle cx="12" cy="12" r="10"></circle>
        <path d="M7 9.5 q5 -1.5 10 1" stroke-width="1.6" fill="none"></path>
        <path d="M7.5 12 q4 -1 8 1" stroke-width="1.6" fill="none"></path>
        <path d="M8 14.8 q3 -0.7 6 0.8" stroke-width="1.6" fill="none"></path>
      </symbol>
    </defs>
  </svg>

  <header>
    <div class="wrap">
      <div class="title digital" style="font-size:28px">World Radio</div>
      <div class="row" style="margin-top:10px">
        <input id="q" class="digital" style="font-size:20px" type="search" placeholder="SÃ¶k station eller tagg (t.ex. 'jazz', 'bbc')" autocomplete="off" />
        <select id="country" class="digital" style="font-size:20px">
          <option value="">Alla lÃ¤nder</option>
        </select>
        <button class="btn digital" id="btnSearch">SÃ–K</button>
        <button class="btn digital" id="btnTop">POPULÃ„RT</button>
        <button class="btn digital" id="btnFavs">FAVORITER</button>
        <button class="btn digital" id="btnDiag">DIAG</button>
      </div>
      <div id="diag" class="diag"></div>
    </div>
  </header>

  <main class="wrap">
    <section id="resultsSection">
      <h2 class="h">Resultat</h2>
      <div id="results" class="grid"></div>
      <div id="resultsEmpty" class="empty digital" style="display:none">â€” INGA TRÃ„FFAR â€”</div>
      <div id="sentinel"></div>
    </section>

    <section id="favsSection" class="nopad" style="display:block">
      <h2 class="h">Favoriter</h2>
      <div id="favs" class="grid"></div>
      <div id="favsEmpty" class="empty digital">â€” INGA FAVORITER Ã„N â€”</div>
    </section>
  </main>

  <!-- Ticker (klicka fÃ¶r kopiering) -->
  <div class="ticker" id="ticker"><div class="tickerInner"><span class="digital" id="tickerText"></span></div></div>

  <!-- Spelare -->
  <div class="audio" id="playerBar" style="display:none">
    <div class="player-grid">
      <div class="station-cover" id="playerCover"></div>
      <div class="meta">
        <div class="name digital">
          <span class="liveDot" id="liveDot" style="display:none"></span>
          <span id="playerName">â€”</span>
        </div>
        <div class="muted digital" id="playerDetails">â€”</div>
      </div>
      <div class="audio-controls">
        <button class="btn small iconbtn" id="btnStop" title="Stoppa" aria-label="Stoppa"><svg class="ico"><use href="#ico-stop"/></svg></button>
        <button class="btn small iconbtn" id="btnPausePlay" title="Spela/Pausa" aria-label="Spela/Pausa"><svg class="ico" id="icoPlayPause"><use href="#ico-play"/></svg></button>
        <button class="btn small iconbtn" id="btnMute" title="Ljud av/pÃ¥" aria-label="Ljud av/pÃ¥"><svg class="ico" id="icoMute"><use href="#ico-volume"/></svg></button>
        <div class="vol-wrap clickIgnore">
          <button class="btn small iconbtn" id="btnVol" title="Volym" aria-haspopup="true" aria-expanded="false"><svg class="ico"><use href="#ico-volume"/></svg></button>
          <div class="vol-pop" id="volPop">
            <input id="volSlider" class="vol-slider" type="range" min="0" max="1" step="0.01" value="1" aria-label="Volym (vertikal)"/>
          </div>
        </div>
        <!-- Spotify-knapp -->
        <a class="btn small iconbtn" id="btnSpotify" href="#" title="Ã–ppna i Spotify" aria-label="Ã–ppna i Spotify"><svg class="ico"><use href="#ico-spotify"/></svg></a>
        <a class="btn small iconbtn" id="btnHome" target="_blank" rel="noopener" title="Ã–ppna stationens webbplats" aria-label="Ã–ppna stationens webbplats"><svg class="ico"><use href="#ico-globe"/></svg></a>
      </div>
    </div>
  </div>

  <div class="toast digital" id="toast"></div>

  <audio id="audio" crossorigin="anonymous" playsinline></audio>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.15/dist/hls.min.js" crossorigin="anonymous"></script>
  <script>
  const API_PROXY = 'https://wradio-proxy.nyhet24-tokamak.workers.dev';

  const $ = sel => document.querySelector(sel);
  const el = (tag, cls) => { const e=document.createElement(tag); if(cls) e.className=cls; return e; };

  /* Plattformdetektion fÃ¶r deeplinks */
  const isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent);
  const isAndroid = /android/i.test(navigator.userAgent);

  // Ã…Ã„Ã–-fix (mojibake -> UTF-8)
  function fixMojibake(s){
    if(!s) return s;
    if(/[ÃƒÃ‚ï¿½]/.test(s)){
      try{
        const bytes = Uint8Array.from(s.split('').map(ch=>ch.charCodeAt(0) & 0xFF));
        const decoded = new TextDecoder('utf-8', {fatal:false}).decode(bytes);
        if(decoded) return decoded;
      }catch{}
      try{ return decodeURIComponent(escape(s)); }catch{}
    }
    return s;
  }

  function fmtTags(t){ return t ? (''+t).split(',').map(s=>s.trim()).filter(Boolean).slice(0,10) : []; }
  const toast = (m)=>{ const t=$('#toast'); t.textContent=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1200); };

  async function api(path){ const r=await fetch(API_PROXY+'?path='+encodeURIComponent(path)); if(!r.ok) throw new Error('API '+r.status); return r.json(); }
  async function now(streamUrl){ try{ const r=await fetch(API_PROXY+'?now=1&stream='+encodeURIComponent(streamUrl)); if(!r.ok) throw 0; return r.json(); }catch{ return null; } }

  // Kopiera till urklipp
  async function copyToClipboard(text){
    if(!text) return;
    try{ await navigator.clipboard.writeText(text); toast('Kopierat'); }
    catch{
      const ta=document.createElement('textarea'); ta.value=text; document.body.appendChild(ta);
      ta.select(); try{ document.execCommand('copy'); toast('Kopierat'); } finally{ document.body.removeChild(ta); }
    }
  }

  // Ticker
  function setTicker(text){
    const span=$('#tickerText'); const msg=fixMojibake((text||'').trim())||'â€”';
    span.textContent='   '+msg+'   '; span.style.animation='none'; void span.offsetWidth; span.style.animation=''; $('#ticker').style.display='flex';
  }
  function hideTicker(){ $('#ticker').style.display='none'; }
  $('#ticker').addEventListener('click', ()=> {
    const t = $('#tickerText').textContent.trim();
    if(t && t !== 'â€”') copyToClipboard(t);
  });

  // Station-kort
  function stationCard(st){
    const card=el('div','card');
    const cover=el('div','station-cover'); if(st.favicon){ const img=new Image(); img.src=st.favicon; cover.append(img);} else cover.innerHTML='ðŸ“»';
    const body=el('div');

    const name=el('div','digital'); name.style.fontSize='20px'; name.textContent=st.name||'OkÃ¤nd station';

    // META â€“ ALLTID synlig (land Â· sprÃ¥k Â· kvalitet)
    const meta=el('div','muted digital');
    const metaParts=[];
    if(st.countrycode) metaParts.push(st.countrycode);
    if(st.language) metaParts.push((''+st.language).split(',')[0]);
    if(st.codec) metaParts.push(st.codec + (st.bitrate?` ${st.bitrate}kbps`:'')); 
    meta.textContent=metaParts.join(' Â· ');

    // TAGGAR â€“ DOLDA tills klick
    const tagsWrap=el('div','tags row');
    const tagsList=fmtTags(st.tags);
    if(tagsList.length){ tagsList.forEach(tag=>{ const p=el('span','pill digital'); p.textContent=tag; tagsWrap.append(p); }); }

    const controls=el('div','controls clickIgnore');
    const btnPlay=el('button','btn primary digital'); btnPlay.textContent='SPELA';
    const btnFav=el('button','btn digital'); btnFav.textContent=isFav(st.stationuuid)?'â˜… FAVORIT':'â˜† FAVORIT';
    const btnHome=el('a','btn iconbtn'); btnHome.title='Ã–ppna stationens webbplats'; btnHome.setAttribute('aria-label','Ã–ppna stationens webbplats'); btnHome.innerHTML='<svg class="ico"><use href="#ico-globe"/></svg>'; btnHome.href=st.homepage||'#'; btnHome.target='_blank'; btnHome.rel='noopener';

    btnPlay.addEventListener('click',(e)=>{ e.stopPropagation(); playStation(st); });
    btnFav.addEventListener('click',(e)=>{ e.stopPropagation(); toggleFav(st,btnFav); });
    btnHome.addEventListener('click',(e)=>{ e.stopPropagation(); });

    // Klick pÃ¥ kortet vÃ¤xlar TAGGAR
    card.addEventListener('click', ()=> { card.classList.toggle('show-tags'); });

    controls.append(btnPlay, btnFav, btnHome);
    body.append(name, meta, tagsWrap, controls);
    card.append(cover, body);
    return card;
  }

  function favCard(st){
    const card=el('div','card'); card.dataset.uuid=st.stationuuid;
    const cover=el('div','station-cover'); cover.style.width='44px'; cover.style.height='44px'; cover.style.borderRadius='10px'; if(st.favicon){ const img=new Image(); img.src=st.favicon; cover.append(img);} else cover.innerHTML='ðŸ“»';
    const body=el('div');
    const name=el('div','digital'); name.style.fontSize='20px'; name.textContent=st.name||'OkÃ¤nd station';
    const nowEl=el('div','muted digital copyable'); nowEl.dataset.role='now'; nowEl.textContent='â€”';
    nowEl.title = 'Klicka fÃ¶r att kopiera';
    nowEl.addEventListener('click',(e)=>{ e.stopPropagation(); copyToClipboard(nowEl.textContent.trim()); });

    const meta=el('div','muted digital');
    const parts=[]; if(st.countrycode) parts.push(st.countrycode);
    if(st.language) parts.push((''+st.language).split(',')[0]);
    if(st.codec) parts.push(st.codec + (st.bitrate?` ${st.bitrate}kbps`:'')); 
    meta.textContent=parts.join(' Â· ');

    const rowBtns=el('div','row clickIgnore');
    const btnPlay=el('button','btn small digital'); btnPlay.textContent='SPELA'; btnPlay.addEventListener('click',(e)=>{ e.stopPropagation(); playStation(st); });
    const btnRm=el('button','btn small digital'); btnRm.textContent='TA BORT'; btnRm.addEventListener('click',(e)=>{ e.stopPropagation(); removeFav(st.stationuuid); });
    const btnHome=el('a','btn small iconbtn'); btnHome.innerHTML='<svg class="ico"><use href="#ico-globe"/></svg>'; btnHome.href=st.homepage||'#'; btnHome.target='_blank'; btnHome.rel='noopener';
    btnHome.addEventListener('click', e=> e.stopPropagation());
    rowBtns.append(btnPlay,btnRm,btnHome);
    body.append(name,nowEl,meta,rowBtns); card.append(cover,body); return card;
  }

  /* PopulÃ¤rt (oÃ¤ndlig scroll, 5 i taget) */
  const TOP_CHUNK=5; let topCache=[]; let topIndex=0; let topKey='GLOBAL'; let io=null;
  function resetTop(key){ topCache=[]; topIndex=0; topKey=key||'GLOBAL'; detachIO(); }
  function detachIO(){ if(io){ io.disconnect(); io=null; } }
  function attachIO(){
    const sentinel = $('#sentinel');
    if(!sentinel) return;
    detachIO();
    io = new IntersectionObserver((entries)=>{
      const e = entries[0];
      if(e && e.isIntersecting && topIndex < topCache.length){
        renderTopChunk();
      }
    }, {root:null, rootMargin:'300px 0px', threshold:0});
    io.observe(sentinel);
  }
  function renderTopChunk(){
    const end=Math.min(topIndex+TOP_CHUNK,topCache.length);
    const frag=document.createDocumentFragment();
    for(let i=topIndex;i<end;i++){ frag.append(stationCard(topCache[i])); }
    if(topIndex===0) $('#results').innerHTML='';
    $('#results').append(frag);
    $('#resultsEmpty').style.display=(topCache.length===0);
    topIndex=end;
    const sentinel = $('#sentinel');
    if(sentinel){ sentinel.remove(); $('#resultsSection').appendChild(sentinel); }
    if(topIndex >= topCache.length){ detachIO(); }
  }

  /* SÃ¶k & listor */
  async function search(q){
    detachIO();
    $('#results').innerHTML=''; $('#resultsEmpty').style.display='none';
    const query=(q||'').trim(); const cc=$('#country').value.trim();
    if(!query && cc) return listTop(cc);
    if(!query) return listTop('GLOBAL');
    const enc=encodeURIComponent(query);
    const tasks=[];
    let base=`/json/stations/search?hidebroken=true&order=clickcount&reverse=true&limit=60&name=${enc}`;
    if(cc) base+=`&countrycode=${encodeURIComponent(cc)}`;
    tasks.push(api(base), api(`/json/stations/byname/${enc}?hidebroken=true&order=clickcount&reverse=true&limit=60`), api(`/json/stations/bytag/${enc}?hidebroken=true&order=clickcount&reverse=true&limit=60`));
    const settled=await Promise.allSettled(tasks);
    const results=settled.filter(x=>x.status==='fulfilled').flatMap(x=>x.value||[]);
    const seen=new Set(); const uniq=[]; for(const st of results){ if(st && !seen.has(st.stationuuid)){ seen.add(st.stationuuid); uniq.push(st); } }
    if(!uniq.length){ $('#resultsEmpty').style.display='block'; return; }
    const frag=document.createDocumentFragment(); uniq.slice(0,120).forEach(st=>frag.append(stationCard(st))); $('#results').append(frag);
  }

  async function listTop(scope){
    const isCountry=scope && scope!=='GLOBAL'; const key=isCountry?`TOP_${scope}`:'GLOBAL';
    if(topKey!==key) resetTop(key);
    $('#results').innerHTML=''; $('#resultsEmpty').style.display='none';
    const sentinel = $('#sentinel'); if(sentinel) sentinel.style.display='block';
    if(topCache.length===0){
      let list=[]; 
      if(isCountry){ list=await api(`/json/stations/bycountrycodeexact/${encodeURIComponent(scope)}?hidebroken=true&order=clickcount&reverse=true&limit=100`); }
      else { list=await api(`/json/stations/topclick?limit=100&hidebroken=true`); }
      topCache=Array.isArray(list)?list:[];
    }
    renderTopChunk();
    attachIO();
  }

  /* LÃ¤nder â€“ alfabetisk sortering */
  async function loadCountries(){
    try{
      const countries=await api('/json/countries?order=stationcount&reverse=true');
      const sel=$('#country');
      (countries||[])
        .filter(c=>c?.name)
        .sort((a,b)=> String(a.name).localeCompare(String(b.name),'sv',{sensitivity:'base'}))
        .forEach(c=>{
          const opt=document.createElement('option');
          opt.value=c.iso_3166_1||c.countrycode||'';
          if(!opt.value && c.name && c.name.length===2) opt.value=c.name.toUpperCase();
          opt.textContent=c.name + (c.stationcount?` (${c.stationcount})`:'');
          if(opt.value) sel.appendChild(opt);
        });
    }catch{}
  }

  /* Media Session (iOS lÃ¥sskÃ¤rm) */
  function setMediaSession(st, info){
    if(!('mediaSession' in navigator)) return;
    const p=parseNP(info);
    const title=fixMojibake(p.title)||st?.name||'Live';
    const artist=fixMojibake(p.artist)||st?.name||'';
    const album=st?.name||'';
    const artwork=st?.favicon&&st.favicon.startsWith('http')?[{src:st.favicon,sizes:'128x128',type:'image/png'}]:[];
    try{
      navigator.mediaSession.metadata=new MediaMetadata({title,artist,album,artwork});
      navigator.mediaSession.playbackState=(audio.paused?'paused':'playing');
      navigator.mediaSession.setActionHandler('play',()=>audio.play());
      navigator.mediaSession.setActionHandler('pause',()=>audio.pause());
      navigator.mediaSession.setActionHandler('stop',()=>{try{audio.pause();}catch{}});
    }catch{}
  }
  function parseNP(info){
    if(!info) return {}; let artist=info?.artist||null, title=info?.title||null, st=info?.streamTitle||'';
    if((!artist||!title) && st){ const p=String(st).split(' - '); if(p.length>=2){ artist=artist||p[0].trim(); title=title||p.slice(1).join(' - ').trim(); } else { title=title||String(st).trim(); } }
    return {artist,title,streamTitle:st};
  }

  const audio = document.getElementById('audio');
  let hls; let npTimer=null; let currentStream=''; let currentStation=null;
  const volPop=$('#volPop'); const volBtn=$('#btnVol'); const volSlider=$('#volSlider'); const VOL_KEY='wr_vol';
  const icoPlayPause=$('#icoPlayPause use'); const icoMute=$('#icoMute use');

  $('#btnPausePlay').addEventListener('click',()=>{ if(audio.paused){ audio.play(); } else { audio.pause(); } updateButtons(); setMediaSession(currentStation,lastNP); });
  $('#btnStop').addEventListener('click',()=>{ if(hls){ hls.destroy(); hls=null; } audio.pause(); audio.src=''; clearInterval(npTimer); hideTicker(); $('#playerName').textContent='â€”'; $('#playerDetails').textContent='â€”'; $('#playerBar').style.display='none'; updateButtons(); setMediaSession(null,null); closeVol(); });
  $('#btnMute').addEventListener('click',()=>{ audio.muted=!audio.muted; updateButtons(); });
  function openVol(){ volPop.classList.add('show'); volBtn.setAttribute('aria-expanded','true'); }
  function closeVol(){ volPop.classList.remove('show'); volBtn.setAttribute('aria-expanded','false'); }
  volBtn.addEventListener('click',(e)=>{ e.stopPropagation(); if(volPop.classList.contains('show')) closeVol(); else openVol(); });
  window.addEventListener('click',(e)=>{ if(!volPop.contains(e.target) && e.target!==volBtn){ closeVol(); } });
  window.addEventListener('scroll', closeVol, {passive:true});

  try{ const saved=localStorage.getItem(VOL_KEY); if(saved!=null){ const v=Math.min(1,Math.max(0,parseFloat(saved))); audio.volume=v; volSlider.value=String(v); } }catch{}
  volSlider.addEventListener('input',e=>{ const v=+e.target.value; audio.volume=v; try{ localStorage.setItem(VOL_KEY,String(v)); }catch{} });

  function updateButtons(){
    icoPlayPause.setAttribute('href', audio.paused?'#ico-play':'#ico-pause');
    icoMute.setAttribute('href', audio.muted?'#ico-volume-mute':'#ico-volume');
    $('#liveDot').style.display=audio.paused?'none':'inline-block';
    if('mediaSession' in navigator){ navigator.mediaSession.playbackState=audio.paused?'paused':'playing'; }
  }

  let lastNP=null;

  /* Spotify: Ã¶ppna appen direkt pÃ¥ iOS/Android, fallback till webbsÃ¶k */
  function openSpotifyFromNowPlaying(){
    let q='';
    const p = parseNP(lastNP || {});
    const artist = fixMojibake(p.artist || '');
    const title  = fixMojibake(p.title  || '');
    if (artist && title) q = `${artist} ${title}`;
    else if (p.streamTitle) q = fixMojibake(p.streamTitle);
    else q = ($('#playerName').textContent || '').trim();

    q = q.replace(/\s+/g,' ').trim();
    if (!q) { toast('Ingen lÃ¥t upptÃ¤ckt Ã¤nnu'); return; }

    const enc = encodeURIComponent(q);
    const web = `https://open.spotify.com/search/${enc}?type=tracks`;

    if (isIOS) {
      setTimeout(()=>{ window.location.href = `spotify://search/${enc}`; }, 0);
      setTimeout(()=>{ window.location.href = `spotify:search:${enc}`; }, 700);
      setTimeout(()=>{ window.location.href = web; }, 1500);
      return;
    }
    if (isAndroid) {
      setTimeout(()=>{ window.location.href = `spotify://search/${enc}`; }, 0);
      setTimeout(()=>{ window.location.href = web; }, 1200);
      return;
    }
    try { window.open(web, '_blank', 'noopener'); }
    catch { location.href = web; }
  }
  document.getElementById('btnSpotify').addEventListener('click', (e)=>{
    e.preventDefault();
    openSpotifyFromNowPlaying();
  });

  async function playStation(st){
    currentStation=st;
    let streamUrl=st.url_resolved||st.url;
    try{ const info=await api('/json/url/'+encodeURIComponent(st.stationuuid)); streamUrl=info?.url||streamUrl; }catch{}
    if(location.protocol==='https:' && /^http:\/\//i.test(streamUrl)){ const httpsTry=streamUrl.replace(/^http:\/\//i,'https://'); try{ await fetch(httpsTry,{method:'HEAD',mode:'no-cors'}); streamUrl=httpsTry; }catch{} }
    currentStream=streamUrl;

    const isHls=/\.m3u8($|\?)/i.test(streamUrl);
    if(hls){ hls.destroy(); hls=null; }
    audio.src=''; if(isHls && window.Hls?.isSupported()){ hls=new Hls({maxBufferLength:20}); hls.loadSource(streamUrl); hls.attachMedia(audio); } else { audio.src=streamUrl; }
    audio.play();

    $('#playerBar').style.display='block';
    $('#playerName').textContent=st.name||'OkÃ¤nd';
    $('#playerDetails').textContent=[st.countrycode, st.codec?(st.codec+(st.bitrate?` ${st.bitrate}kbps`:'')):null].filter(Boolean).join(' Â· ');
    const cov=$('#playerCover'); cov.innerHTML=''; if(st.favicon){ const img=new Image(); img.src=st.favicon; cov.append(img);} else { cov.textContent='ðŸ“»'; }
    const home=$('#btnHome'); home.href=st.homepage||'#';
    updateButtons();

    setTicker('Lyssnar pÃ¥ '+(st.name||'okÃ¤nd station'));
    lastNP={streamTitle:st.name}; setMediaSession(st,lastNP);

    clearInterval(npTimer);
    const tick=async()=>{ try{
        const info=await now(currentStream); lastNP=info||lastNP;
        const p=parseNP(lastNP);
        const lineRaw=(p.artist&&p.title)?`${p.artist} â€“ ${p.title}`:(p.streamTitle||'â€”');
        const line=fixMojibake(lineRaw);
        setTicker(line && line!=='â€”' ? line : ('Lyssnar pÃ¥ '+(st.name||'okÃ¤nd station')));
        setMediaSession(st,lastNP);
      }catch{}
    };
    await tick(); npTimer=setInterval(tick,15000);
  }

  /* Favoriter */
  const favKey='wr_favs_v1';
  const getFavs=()=>{ try{ return JSON.parse(localStorage.getItem(favKey)||'[]'); }catch{ return []; } };
  const setFavs=(x)=>localStorage.setItem(favKey,JSON.stringify(x));
  const isFav=(uuid)=>getFavs().some(f=>f.uuid===uuid);
  function toggleFav(st,btn){
    const favs=getFavs(); const i=favs.findIndex(f=>f.uuid===st.stationuuid);
    if(i>=0){ favs.splice(i,1); setFavs(favs); btn.textContent='â˜† FAVORIT'; toast('BORTTAGEN'); refreshFavs(); return; }
    favs.push({uuid:st.stationuuid, snap:st}); setFavs(favs); btn.textContent='â˜… FAVORIT'; toast('TILLAGD'); refreshFavs();
  }
  function removeFav(uuid){ const favs=getFavs().filter(f=>f.uuid!==uuid); setFavs(favs); refreshFavs(); }

  let favNpTimer=null;
  async function refreshFavs(){
    const favs=getFavs();
    $('#favs').innerHTML=''; $('#favsEmpty').style.display=favs.length?'none':'block'; if(!favs.length){ clearInterval(favNpTimer); return; }
    const uuids=favs.map(f=>f.uuid).join(','); let updated=[]; try{ updated=await api('/json/stations/byuuid?uuids='+encodeURIComponent(uuids)); }catch{}
    const map=new Map(updated.map(s=>[s.stationuuid,s])); const frag=document.createDocumentFragment();
    favs.forEach(f=>{ const s=map.get(f.uuid)||f.snap; if(!s) return; frag.append(favCard(s)); });
    $('#favs').append(frag);

    clearInterval(favNpTimer);
    const tickFavs=async()=>{ const cards=Array.from(document.querySelectorAll('#favs .card')); for(const card of cards){
      const uuid=card.dataset.uuid; let st=map.get(uuid)||favs.find(f=>f.uuid===uuid)?.snap; if(!st) continue;
      let url=st.url_resolved||st.url; try{ const info=await api('/json/url/'+encodeURIComponent(uuid)); url=info?.url||url; }catch{}
      if(location.protocol==='https:'&&/^http:\/\//i.test(url)){ const httpsTry=url.replace(/^http:\/\//i,'https://'); try{ await fetch(httpsTry,{method:'HEAD',mode:'no-cors'}); url=httpsTry; }catch{} }
      try{
        const np=await now(url); const p=parseNP(np);
        const lineRaw=(p.artist&&p.title)?`${p.artist} â€“ ${p.title}`:(p.streamTitle||'â€”');
        const line=fixMojibake(lineRaw);
        const tgt=card.querySelector('[data-role="now"]'); if(tgt) tgt.textContent=line||'â€”';
      }catch{}
    }};
    await tickFavs(); favNpTimer=setInterval(tickFavs,20000);
  }

  /* Diagnostik */
  function showDiag(msg){ const d=$('#diag'); d.style.display='block'; d.textContent=msg; d.classList.add('digital'); }
  $('#btnDiag').addEventListener('click', async ()=>{ try{ const stats=await api('/json/stats'); showDiag('PROXY OK Â· STATIONER: '+(stats.stations||'?')); } catch(err){ showDiag('PROXY FEL: '+err.message); } });

  /* HÃ¤ndelser */
  $('#btnSearch').addEventListener('click', ()=>{ const v=$('#q').value.trim(); document.body.classList.remove('mode-favs'); search(v); });
  $('#q').addEventListener('keydown', e=>{ if(e.key==='Enter'){ $('#btnSearch').click(); }});
  $('#btnTop').addEventListener('click', ()=>{ document.body.classList.remove('mode-favs'); const cc=$('#country').value.trim(); listTop(cc||'GLOBAL'); window.scrollTo({top:0,behavior:'smooth'}); });
  $('#btnFavs').addEventListener('click', ()=>{ document.body.classList.add('mode-favs'); document.querySelector('#favsSection').scrollIntoView({behavior:'smooth'}); });
  $('#country').addEventListener('change', ()=>{ const q=$('#q').value.trim(); document.body.classList.remove('mode-favs'); if(q) search(q); else listTop($('#country').value.trim()||'GLOBAL'); });

  /* Init */
  (async function init(){
    await loadCountries();
    try{ await listTop('GLOBAL'); }catch(e){ $('#resultsEmpty').style.display='block'; showDiag('INITFEL: '+e.message); }
    refreshFavs();
    audio.addEventListener('play', ()=>{ if('mediaSession' in navigator){ navigator.mediaSession.playbackState='playing'; } });
    audio.addEventListener('pause', ()=>{ if('mediaSession' in navigator){ navigator.mediaSession.playbackState='paused'; } });
  })();
  </script>
</body>
</html>
