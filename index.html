<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <!-- Ingen mobil-zoom -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>World Radio</title>
  <meta name="description" content="Lyssna p√• radiostationer fr√•n hela v√§rlden. S√∂k via egen Cloudflare Worker-proxy. Spara favoriter.">
  <!-- Retro digitalfont f√∂r ticker -->
  <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#000;--panel:#12131a;--muted:#7a8194;--text:#e6e9f2;--accent:#4f46e5;--border:#222433;
      --green:#b1ffd2; --player-h: 110px; --ticker-h: 34px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    html{ -webkit-text-size-adjust: 100%; }
    body{
      margin:0;font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif;color:var(--text);
      background:#000;
      touch-action: manipulation;
      /* reservera plats f√∂r ticker + spelare + safe area */
      padding-bottom: calc(var(--ticker-h) + var(--player-h) + env(safe-area-inset-bottom) + 20px);
    }
    header{position:sticky;top:0;background:rgba(0,0,0,.72);backdrop-filter:blur(8px);z-index:10;border-bottom:1px solid var(--border)}
    .wrap{max-width:1100px;margin:0 auto;padding:14px 12px}
    .title{display:flex;gap:8px;align-items:center;font-weight:700}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(0,0,0,.05));border:1px solid var(--border);border-radius:14px;padding:10px;display:flex;gap:10px;align-items:flex-start}
    .card:hover{border-color:#2a2d40}
    .station-cover{flex:0 0 auto;width:50px;height:50px;border-radius:12px;background:#0e0f15;border:1px solid var(--border);display:grid;place-items:center;overflow:hidden}
    .station-cover img{width:100%;height:100%;object-fit:cover}
    .muted{color:var(--muted)}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    input[type="search"], select{
      background:#0e0f15;border:1px solid var(--border);color:var(--text);padding:10px 12px;border-radius:10px;width:100%;
      font-size:16px; /* iOS anti-zoom */
    }
    .pill{font-size:12px;padding:2px 6px;border:1px solid var(--border);border-radius:999px;color:var(--muted)}
    .controls{display:grid;grid-template-columns:1fr auto auto;gap:8px;margin-top:8px}
    .btn{
      background:#10121a;border:1px solid var(--border);padding:9px 12px;border-radius:10px;color:var(--text);cursor:pointer;font-size:16px;
      text-decoration:none;
    }
    .btn:hover{border-color:#2a2d40}
    .btn.primary{background:linear-gradient(180deg,#4f46e5,#4338ca);border:none}
    .btn.small{padding:6px 9px;border-radius:8px}
    .btn.ghost{background:transparent;border:1px dashed #2a2d40}
    .iconbtn{display:inline-flex;align-items:center;justify-content:center;min-width:44px;line-height:1;text-decoration:none}
    .btn:link,.btn:visited{ text-decoration:none }
    .icon{font-size:18px;line-height:1;display:block}

    .h{margin:16px 0 8px;font-size:13px;color:#aab3d0;text-transform:uppercase;letter-spacing:.12em}
    .empty{opacity:.7;border:1px dashed var(--border);border-radius:10px;padding:14px;text-align:center}
    .diag{margin-top:8px;font-size:12px;color:#fbbf24}
    .toast{position:fixed;right:12px;bottom:calc(var(--ticker-h) + var(--player-h) + env(safe-area-inset-bottom) + 12px);background:#1b1d29;color:#e6e9f2;border:1px solid #2a2d40;padding:7px 9px;border-radius:9px;font-size:13px;opacity:0;transform:translateY(6px);transition:.18s}
    .toast.show{opacity:1;transform:none}

    /* "Visa mer" ‚Äì bara l√§ngst ned efter stationerna */
    .more-wrap{display:flex;justify-content:center;margin:16px 0 24px}

    /* Digital ticker ovanf√∂r spelaren (r√§knar in safe area) */
    .ticker{
      position:fixed;left:0;right:0;
      bottom:calc(var(--player-h) + env(safe-area-inset-bottom));
      height:var(--ticker-h);
      background:#0a1112;border-top:1px solid var(--border);border-bottom:1px solid var(--border);
      display:none;align-items:center;overflow:hidden;z-index:20;
    }
    .tickerInner{
      width:100%;white-space:nowrap;overflow:hidden;
      font-family:'VT323', ui-monospace, SFMono-Regular, Consolas, monospace;
      font-size:22px;line-height:1;color:var(--green);letter-spacing:0.02em;
      text-shadow:0 0 6px rgba(177,255,210,.45);
    }
    .tickerRun{display:inline-block;padding-left:100%;will-change:transform;animation: ticker 20s linear infinite}
    @keyframes ticker{ from{ transform:translateX(0);} to{ transform:translateX(-100%);} }

    /* Spelare (fast nederkant, r√§knar in safe area) */
    .audio{
      position:fixed;left:0;right:0;bottom:0;
      height:calc(var(--player-h) + env(safe-area-inset-bottom));
      background:rgba(0,0,0,1); /* helsvart */
      backdrop-filter:blur(8px);
      border-top:1px solid var(--border);
      display:flex;gap:12px;align-items:center;padding:10px 12px;
      padding-bottom:calc(10px + env(safe-area-inset-bottom)); /* l√§gg plats f√∂r home-bar */
      z-index:21;
    }
    .audio .station-cover{width:64px;height:64px;border-radius:14px}
    .audio .meta{min-width:0;display:flex;flex-direction:column;gap:4px}
    .meta .name{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:18px;font-weight:700}
    .meta .muted{font-size:12px}
    .liveDot{width:10px;height:10px;border-radius:50%;background:#ef4444;box-shadow:0 0 12px rgba(239,68,68,.8);margin-right:6px;display:inline-block;vertical-align:middle}
    .audio-controls{display:flex;gap:8px;align-items:center;margin-left:auto}
    .audio input[type="range"]{width:120px}

    /* Volym-popover (vertikalt reglage) */
    .vol-wrap{position:relative}
    .vol-pop{
      position:absolute; right:0; bottom:calc(100% + 10px);
      background:#0d0f14;border:1px solid #2a2d40;border-radius:12px;padding:10px; z-index:30;
      box-shadow:0 6px 20px rgba(0,0,0,.35);
      display:none;
    }
    .vol-pop.show{ display:block; }
    .vol-slider{
      display:block; margin:0 auto;
      width:28px; height:140px;
      writing-mode: bt-lr;             /* IE/Edge legacy */
      -webkit-appearance: slider-vertical; /* iOS Safari */
      appearance: slider-vertical;
    }

    /* Favoriter-vy */
    body.mode-favs #resultsSection{display:none}
    body.mode-favs #favsSection{display:block}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="title">World Radio</div>
      <div class="row" style="margin-top:10px">
        <input id="q" type="search" placeholder="S√∂k station eller tagg (t.ex. 'jazz', 'bbc')" autocomplete="off" />
        <select id="country">
          <option value="">Alla l√§nder</option>
        </select>
        <button class="btn" id="btnSearch">S√∂k</button>
        <button class="btn" id="btnTop">Popul√§rt</button>
        <button class="btn" id="btnFavs">Favoriter</button>
        <button class="btn" id="btnDiag">Diagnostik</button>
      </div>
      <div id="diag" class="diag" style="display:none"></div>
    </div>
  </header>

  <main class="wrap">
    <section id="resultsSection">
      <h2 class="h">Resultat</h2>
      <div id="results" class="grid"></div>
      <div id="resultsEmpty" class="empty" style="display:none">Inga tr√§ffar √§nnu ‚Äî s√∂k (ex. "BBC", "Jazz") eller tryck <em>Popul√§rt</em>.</div>
      <div class="more-wrap">
        <button class="btn ghost" id="btnMore" style="display:none">Visa mer</button>
      </div>
    </section>

    <section id="favsSection" class="nopad">
      <h2 class="h">Favoriter</h2>
      <div id="favs" class="grid"></div>
      <div id="favsEmpty" class="empty">Inga favoriter √§n. L√§gg till n√•gon station s√• visas den h√§r.</div>
    </section>
  </main>

  <!-- Digital ticker-bar -->
  <div class="ticker" id="ticker"><div class="tickerInner"><span class="tickerRun" id="tickerText"></span></div></div>

  <!-- Spelare -->
  <div class="audio" id="playerBar" style="display:none">
    <div class="station-cover" id="playerCover"></div>
    <div class="meta">
      <div class="name"><span class="liveDot" id="liveDot" style="display:none"></span><span id="playerName">‚Äî</span></div>
      <div class="muted" id="playerDetails">‚Äî</div>
    </div>
    <div class="audio-controls">
      <button class="btn small" id="btnStop" title="Stoppa">‚èπ</button>
      <button class="btn small" id="btnPausePlay" title="Spela/Pausa">‚ñ∂</button>
      <button class="btn small" id="btnMute" title="Ljud av/p√•">üîä</button>

      <!-- Ny volymknapp + popover -->
      <div class="vol-wrap">
        <button class="btn small iconbtn" id="btnVol" title="Volym" aria-haspopup="true" aria-expanded="false">üîà</button>
        <div class="vol-pop" id="volPop">
          <input id="volSlider" class="vol-slider" type="range" min="0" max="1" step="0.01" value="1" aria-label="Volym (vertikal)"/>
        </div>
      </div>

      <!-- Jordglob utan vit linje -->
      <a class="btn small iconbtn" id="btnHome" target="_blank" rel="noopener" title="√ñppna stationens webbplats" aria-label="√ñppna stationens webbplats">
        <span class="icon" aria-hidden="true">üåê</span>
      </a>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <audio id="audio" crossorigin="anonymous" playsinline></audio>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.15/dist/hls.min.js" crossorigin="anonymous"></script>
  <script>
  // ======= KONFIG: din Worker-proxy =======
  const API_PROXY = 'https://wradio-proxy.nyhet24-tokamak.workers.dev';

  // ======= Hj√§lp =======
  const $ = sel => document.querySelector(sel);
  const el = (tag, cls) => { const e=document.createElement(tag); if(cls) e.className=cls; return e; };
  const fmtTags = t => t ? (''+t).split(',').slice(0,3).map(s=>s.trim()).filter(Boolean) : [];
  const toast = (m)=>{ const t=$('#toast'); t.textContent=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1300); };

  // ======= API via din proxy =======
  async function api(path){
    const url = API_PROXY + '?path=' + encodeURIComponent(path);
    const r = await fetch(url);
    if(!r.ok) throw new Error('API ' + r.status);
    return await r.json();
  }
  async function now(streamUrl){
    try{
      const r = await fetch(API_PROXY + '?now=1&stream=' + encodeURIComponent(streamUrl));
      if(!r.ok) throw 0; return await r.json();
    }catch{ return null; }
  }

  // ======= Ticker =======
  function setTicker(text){
    const bar = $('#ticker');
    const span = $('#tickerText');
    const msg = (text || '').trim() || '‚Äî';
    span.textContent = '   ' + msg + '   ';
    span.classList.remove('tickerRun'); void span.offsetWidth; span.classList.add('tickerRun');
    bar.style.display = 'flex';
  }
  function hideTicker(){ $('#ticker').style.display='none'; }

  // ======= Kort =======
  function stationCard(st){
    const card = el('div','card');
    const cover = el('div','station-cover');
    if(st.favicon){ const img=new Image(); img.src=st.favicon; img.alt=''; cover.append(img);} else { cover.innerHTML='üìª'; }
    const body = el('div');
    const name = el('div'); name.textContent = st.name || 'Ok√§nd station';
    const meta = el('div','muted');
    const parts=[]; if(st.countrycode) parts.push(st.countrycode); if(st.language) parts.push((''+st.language).split(',')[0]); if(st.codec) parts.push(st.codec + (st.bitrate?` ${st.bitrate}kbps`:'')); 
    meta.textContent = parts.join(' ¬∑ ');
    const tags = el('div','row'); fmtTags(st.tags).forEach(tag=>{ const p=el('span','pill'); p.textContent=tag; tags.append(p); });
    const controls = el('div','controls');
    const btnPlay = el('button','btn primary'); btnPlay.textContent='Spela';
    const btnFav = el('button','btn'); btnFav.textContent = isFav(st.stationuuid) ? '‚òÖ Sparad' : '‚òÜ Favorit';
    const btnHome = el('a','btn iconbtn'); btnHome.title='√ñppna stationens webbplats'; btnHome.setAttribute('aria-label','√ñppna stationens webbplats'); btnHome.innerHTML='<span class="icon" aria-hidden="true">üåê</span>'; btnHome.href=st.homepage||'#'; btnHome.target='_blank'; btnHome.rel='noopener';
    btnPlay.addEventListener('click', ()=> playStation(st));
    btnFav.addEventListener('click', ()=> toggleFav(st, btnFav));
    controls.append(btnPlay, btnFav, btnHome);
    body.append(name, meta, tags, controls);
    card.append(cover, body);
    return card;
  }

  function favCard(st){
    const card = el('div','card'); card.dataset.uuid = st.stationuuid;
    const cover = el('div','station-cover'); cover.style.width='44px'; cover.style.height='44px'; cover.style.borderRadius='10px';
    if(st.favicon){ const img=new Image(); img.src=st.favicon; cover.append(img);} else { cover.innerHTML='üìª'; }
    const body = el('div');
    const name = el('div'); name.textContent = st.name || 'Ok√§nd station'; name.style.fontWeight='600'; name.className='name';
    const nowEl = el('div'); nowEl.className = 'muted'; nowEl.dataset.role='now'; nowEl.textContent='‚Äî';
    const meta = el('div','muted'); const parts=[]; if(st.countrycode) parts.push(st.countrycode); if(st.language) parts.push((''+st.language).split(',')[0]); meta.textContent=parts.join(' ¬∑ ');
    const rowBtns = el('div','row');
    const btnPlay = el('button','btn small'); btnPlay.textContent='Spela'; btnPlay.addEventListener('click',()=> playStation(st));
    const btnRm = el('button','btn small'); btnRm.textContent='Ta bort'; btnRm.addEventListener('click',()=> removeFav(st.stationuuid));
    const btnHome = el('a','btn small iconbtn'); btnHome.title='√ñppna stationens webbplats'; btnHome.setAttribute('aria-label','√ñppna stationens webbplats'); btnHome.innerHTML='<span class="icon" aria-hidden="true">üåê</span>'; btnHome.href=st.homepage||'#'; btnHome.target='_blank'; btnHome.rel='noopener';
    rowBtns.append(btnPlay, btnRm, btnHome);
    body.append(name, nowEl, meta, rowBtns); card.append(cover, body); return card;
  }

  // ======= Popul√§rt (5 i taget) =======
  const TOP_CHUNK = 5;
  let topCache = []; let topIndex = 0; let topKey = 'GLOBAL';
  function resetTop(key){ topCache = []; topIndex = 0; topKey = key || 'GLOBAL'; $('#btnMore').style.display = 'none'; }
  function renderTopChunk(){
    const end = Math.min(topIndex + TOP_CHUNK, topCache.length);
    const frag = document.createDocumentFragment();
    for(let i=topIndex;i<end;i++){ frag.append(stationCard(topCache[i])); }
    if(topIndex===0) $('#results').innerHTML='';
    $('#results').append(frag);
    $('#resultsEmpty').style.display = (topCache.length===0);
    topIndex = end;
    $('#btnMore').style.display = (topIndex < topCache.length) ? 'inline-flex' : 'none';
  }

  // ======= S√∂k & listor =======
  async function search(q){
    $('#results').innerHTML=''; $('#resultsEmpty').style.display='none'; $('#btnMore').style.display='none';
    const query = (q||'').trim();
    const cc = $('#country').value.trim();
    if(!query && cc){ return listTop(cc); }
    if(!query){ return listTop('GLOBAL'); }
    const enc = encodeURIComponent(query);
    const tasks = [];
    let base = `/json/stations/search?hidebroken=true&order=clickcount&reverse=true&limit=60&name=${enc}`;
    if(cc) base += `&countrycode=${encodeURIComponent(cc)}`;
    tasks.push(api(base));
    tasks.push(api(`/json/stations/byname/${enc}?hidebroken=true&order=clickcount&reverse=true&limit=60`));
    tasks.push(api(`/json/stations/bytag/${enc}?hidebroken=true&order=clickcount&reverse=true&limit=60`));
    const settled = await Promise.allSettled(tasks);
    const results = settled.filter(x=>x.status==='fulfilled').flatMap(x=>x.value||[]);
    const seen = new Set(); const uniq = [];
    for(const st of results){ if(st && !seen.has(st.stationuuid)){ seen.add(st.stationuuid); uniq.push(st); } }
    if(!uniq.length){ $('#resultsEmpty').style.display='block'; return; }
    const frag = document.createDocumentFragment(); uniq.slice(0,60).forEach(st=> frag.append(stationCard(st))); $('#results').append(frag);
  }

  async function listTop(scope){
    const isCountry = scope && scope !== 'GLOBAL';
    const key = isCountry ? `TOP_${scope}` : 'GLOBAL';
    if(topKey !== key) resetTop(key);
    $('#results').innerHTML=''; $('#resultsEmpty').style.display='none';
    if(topCache.length === 0){
      let list = [];
      if(isCountry){
        list = await api(`/json/stations/bycountrycodeexact/${encodeURIComponent(scope)}?hidebroken=true&order=clickcount&reverse=true&limit=100`);
      }else{
        list = await api(`/json/stations/topclick?limit=100&hidebroken=true`);
      }
      topCache = Array.isArray(list) ? list : [];
    }
    renderTopChunk();
  }

  // ======= L√§nder (dropdown) =======
  async function loadCountries(){
    try{
      const countries = await api('/json/countries?order=stationcount&reverse=true');
      const sel = $('#country');
      countries.forEach(c=>{
        const opt = document.createElement('option');
        opt.value = c.iso_3166_1 || c.countrycode || '';
        if(!opt.value && c.name && c.name.length===2) opt.value = c.name.toUpperCase();
        opt.textContent = c.name + (c.stationcount ? ` (${c.stationcount})` : '');
        if(opt.value) sel.appendChild(opt);
      });
    }catch(e){ /* ignore */ }
  }

  // ======= Media Session (iPhone l√•ssk√§rm) =======
  function setMediaSession(st, info){
    if(!('mediaSession' in navigator)) return;
    const parsed = parseNP(info);
    const title = parsed.title || st?.name || 'Live';
    const artist = parsed.artist || st?.name || '';
    const album = st?.name || '';
    const artwork = st?.favicon && st.favicon.startsWith('http')
      ? [{ src: st.favicon, sizes: '128x128', type: 'image/png' }]
      : [];
    try {
      navigator.mediaSession.metadata = new MediaMetadata({ title, artist, album, artwork });
      navigator.mediaSession.playbackState = (audio.paused ? 'paused' : 'playing');
      navigator.mediaSession.setActionHandler('play', () => audio.play());
      navigator.mediaSession.setActionHandler('pause', () => audio.pause());
      navigator.mediaSession.setActionHandler('stop', () => { try{ audio.pause(); }catch{} });
    } catch {}
  }
  function parseNP(info){
    if(!info) return {};
    let artist = info.artist || null, title = info.title || null, st = info.streamTitle || '';
    if((!artist || !title) && st){
      const p = String(st).split(' - ');
      if(p.length >= 2){ artist = artist || p[0].trim(); title = title || p.slice(1).join(' - ').trim(); }
      else { title = title || String(st).trim(); }
    }
    return { artist, title, streamTitle: st };
  }

  // ======= Spelare + Now Playing =======
  const audio = $('#audio'); let hls; let npTimer=null; let currentStream=''; let currentStation=null;
  const volPop = $('#volPop'); const volBtn = $('#btnVol'); const volSlider = $('#volSlider');
  const VOL_KEY = 'wr_vol';

  $('#btnPausePlay').addEventListener('click',()=>{ if(audio.paused){ audio.play(); } else { audio.pause(); } updateButtons(); setMediaSession(currentStation, lastNP); });
  $('#btnStop').addEventListener('click',()=>{ if(hls){ hls.destroy(); hls=null; } audio.pause(); audio.src=''; clearInterval(npTimer); hideTicker(); $('#playerName').textContent='‚Äî'; $('#playerDetails').textContent='‚Äî'; $('#playerBar').style.display='none'; updateButtons(); setMediaSession(null,null); closeVol(); });
  $('#btnMute').addEventListener('click',()=>{ audio.muted = !audio.muted; updateButtons(); });

  function openVol(){ volPop.classList.add('show'); volBtn.setAttribute('aria-expanded','true'); }
  function closeVol(){ volPop.classList.remove('show'); volBtn.setAttribute('aria-expanded','false'); }
  volBtn.addEventListener('click', (e)=>{ e.stopPropagation(); if(volPop.classList.contains('show')) closeVol(); else openVol(); });
  window.addEventListener('click', (e)=>{ if(!volPop.contains(e.target) && e.target!==volBtn){ closeVol(); } });
  window.addEventListener('scroll', closeVol, { passive:true });

  // spara/√•terst√§ll volym
  try{
    const saved = localStorage.getItem(VOL_KEY);
    if(saved!=null){ const v = Math.min(1, Math.max(0, parseFloat(saved))); audio.volume = v; volSlider.value = String(v); }
  }catch{}
  volSlider.addEventListener('input', e=>{ const v = +e.target.value; audio.volume = v; try{ localStorage.setItem(VOL_KEY, String(v)); }catch{} });

  function updateButtons(){
    $('#btnPausePlay').textContent = audio.paused ? '‚ñ∂' : '‚è∏';
    $('#btnMute').textContent = audio.muted ? 'üîá' : 'üîä';
    $('#liveDot').style.display = audio.paused ? 'none' : 'inline-block';
    if('mediaSession' in navigator){ navigator.mediaSession.playbackState = audio.paused ? 'paused' : 'playing'; }
  }

  let lastNP = null; // senaste now playing-objektet
  async function playStation(st){
    currentStation = st;
    let streamUrl = st.url_resolved || st.url;
    try{ const info = await api('/json/url/' + encodeURIComponent(st.stationuuid)); streamUrl = info?.url || streamUrl; }catch{}
    if(location.protocol==='https:' && /^http:\/\//i.test(streamUrl)){
      const httpsTry = streamUrl.replace(/^http:\/\//i,'https://');
      try{ await fetch(httpsTry, { method:'HEAD', mode:'no-cors' }); streamUrl = httpsTry; }catch{}
    }
    currentStream = streamUrl;

    const isHls = /\.m3u8($|\?)/i.test(streamUrl);
    if(hls){ hls.destroy(); hls=null; }
    audio.src = '';
    if(isHls && window.Hls?.isSupported()){
      hls = new Hls({maxBufferLength:20}); hls.loadSource(streamUrl); hls.attachMedia(audio);
    } else { audio.src = streamUrl; }
    audio.play();

    $('#playerBar').style.display='flex';
    $('#playerName').textContent = st.name || 'Ok√§nd';
    $('#playerDetails').textContent = [st.countrycode, st.codec ? (st.codec + (st.bitrate?` ${st.bitrate}kbps`:'')) : null].filter(Boolean).join(' ¬∑ ');
    const cov=$('#playerCover'); cov.innerHTML=''; if(st.favicon){ const img=new Image(); img.src=st.favicon; cov.append(img);} else { cov.textContent='üìª'; }
    const home=$('#btnHome'); home.href = st.homepage||'#';
    updateButtons();

    setTicker('Lyssnar p√• ' + (st.name || 'ok√§nd station'));
    lastNP = { streamTitle: st.name };
    setMediaSession(st, lastNP); // initial metadata

    clearInterval(npTimer);
    const tick = async () => {
      try{
        const info = await now(currentStream);
        lastNP = info || lastNP;
        const p = parseNP(lastNP);
        const line = (p.artist && p.title) ? `${p.artist} ‚Äì ${p.title}` : (p.streamTitle || '‚Äî');
        setTicker(line && line !== '‚Äî' ? line : ('Lyssnar p√• ' + (st.name || 'ok√§nd station')));
        setMediaSession(st, lastNP);
      }catch{ /* beh√•ll f√∂reg√•ende */ }
    };
    await tick();
    npTimer = setInterval(tick, 15000);
  }

  // ======= Favoriter (+ Now Playing) =======
  const favKey = 'wr_favs_v1';
  const getFavs = () => { try{ return JSON.parse(localStorage.getItem(favKey)||'[]'); }catch{ return []; } };
  const setFavs = (x) => localStorage.setItem(favKey, JSON.stringify(x));
  const isFav = (uuid) => getFavs().some(f=> f.uuid===uuid);
  function toggleFav(st, btn){
    const favs = getFavs();
    const i = favs.findIndex(f=> f.uuid===st.stationuuid);
    if(i>=0){ favs.splice(i,1); setFavs(favs); btn.textContent='‚òÜ Favorit'; toast('Borttagen fr√•n favoriter'); refreshFavs(); return; }
    favs.push({uuid: st.stationuuid, snap: st}); setFavs(favs); btn.textContent='‚òÖ Sparad'; toast('Tillagd i favoriter'); refreshFavs();
  }
  function removeFav(uuid){ const favs = getFavs().filter(f=> f.uuid!==uuid); setFavs(favs); refreshFavs(); }

  let favNpTimer=null;
  async function refreshFavs(){
    const favs = getFavs();
    $('#favs').innerHTML=''; $('#favsEmpty').style.display = favs.length ? 'none' : 'block'; if(!favs.length){ clearInterval(favNpTimer); return; }
    const uuids = favs.map(f=> f.uuid).join(',');
    let updated=[]; try{ updated = await api('/json/stations/byuuid?uuids=' + encodeURIComponent(uuids)); }catch{}
    const map = new Map(updated.map(s=> [s.stationuuid, s]));
    const frag = document.createDocumentFragment();
    favs.forEach(f=>{ const s = map.get(f.uuid) || f.snap; if(!s) return; frag.append(favCard(s)); });
    $('#favs').append(frag);

    clearInterval(favNpTimer);
    const tickFavs = async ()=>{
      const cards = Array.from(document.querySelectorAll('#favs .card'));
      for(const card of cards){
        const uuid = card.dataset.uuid;
        let st = map.get(uuid) || favs.find(f=>f.uuid===uuid)?.snap;
        if(!st) continue;
        let url = st.url_resolved || st.url;
        try{ const info = await api('/json/url/' + encodeURIComponent(uuid)); url = info?.url || url; }catch{}
        if(location.protocol==='https:' && /^http:\/\//i.test(url)){
          const httpsTry = url.replace(/^http:\/\//i,'https://');
          try{ await fetch(httpsTry, { method:'HEAD', mode:'no-cors' }); url = httpsTry; }catch{}
        }
        try{
          const np = await now(url);
          const p = parseNP(np);
          const line = (p.artist && p.title) ? `${p.artist} ‚Äì ${p.title}` : (p.streamTitle || '‚Äî');
          const tgt = card.querySelector('[data-role="now"]');
          if(tgt) tgt.textContent = line || '‚Äî';
        }catch{}
      }
    };
    await tickFavs();
    favNpTimer = setInterval(tickFavs, 20000);
  }

  // ======= Diagnostik =======
  function showDiag(msg){ const d=$('#diag'); d.style.display='block'; d.textContent=msg; }
  $('#btnDiag').addEventListener('click', async ()=>{
    try{ const stats = await api('/json/stats'); showDiag('Proxy OK ¬∑ stationer: ' + (stats.stations||'?')); }
    catch(err){ showDiag('Proxy FEL: ' + err.message); }
  });

  // ======= H√§ndelser =======
  $('#btnSearch').addEventListener('click', ()=> { const v = $('#q').value.trim(); document.body.classList.remove('mode-favs'); search(v); });
  $('#q').addEventListener('keydown', e=>{ if(e.key==='Enter'){ $('#btnSearch').click(); }});
  $('#btnTop').addEventListener('click', ()=> {
    document.body.classList.remove('mode-favs');
    const cc = $('#country').value.trim();
    listTop(cc || 'GLOBAL');
    window.scrollTo({top:0, behavior:'smooth'});
  });
  $('#btnFavs').addEventListener('click', ()=> {
    document.body.classList.add('mode-favs');
    document.querySelector('#favsSection').scrollIntoView({behavior:'smooth'});
  });
  $('#btnMore').addEventListener('click', renderTopChunk);
  $('#country').addEventListener('change', ()=>{
    const q = $('#q').value.trim();
    document.body.classList.remove('mode-favs');
    if(q) search(q); else listTop($('#country').value.trim() || 'GLOBAL');
  });

  // ======= Init =======
  (async function init(){
    await loadCountries();
    try{ await listTop('GLOBAL'); }catch(e){ $('#resultsEmpty').style.display='block'; showDiag('Initfel: ' + e.message); }
    refreshFavs();

    // Media Session state hooks (f√∂r iOS)
    audio.addEventListener('play', ()=>{ if('mediaSession' in navigator){ navigator.mediaSession.playbackState='playing'; } });
    audio.addEventListener('pause', ()=>{ if('mediaSession' in navigator){ navigator.mediaSession.playbackState='paused'; } });
  })();
  </script>
</body>
</html>
